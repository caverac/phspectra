name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'

# Required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Python Jobs (run in parallel)
  # ===========================================================================

  lint-python:
    name: Lint (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --group test-lambda

      - name: Check formatting with black
        run: >-
          uv run black --check
          packages/phspectra/src/
          packages/phspectra/tests/
          packages/infrastructure/lambda/

      - name: Check import order with isort
        run: >-
          uv run isort --check-only
          packages/phspectra/src/
          packages/phspectra/tests/
          packages/infrastructure/lambda/

      - name: Lint with flake8
        run: >-
          uv run flake8
          packages/phspectra/src/
          packages/phspectra/tests/
          packages/infrastructure/lambda/

      - name: Lint with pylint
        run: >-
          uv run pylint
          packages/phspectra/src/
          packages/phspectra/tests/
          packages/infrastructure/lambda/splitter/
          packages/infrastructure/lambda/worker/
          packages/infrastructure/lambda/tests/

      - name: Check docstrings with pydocstyle
        run: >-
          uv run pydocstyle
          packages/phspectra/src/
          packages/infrastructure/lambda/splitter/
          packages/infrastructure/lambda/worker/

  typecheck-python:
    name: Typecheck (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Run mypy
        run: uv run mypy packages/phspectra/src/

  test-python:
    name: Test (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --group test-lambda

      - name: Run tests
        run: uv run python -m pytest -m "not slow" -v

  # ===========================================================================
  # JS/TS Jobs (run in parallel)
  # ===========================================================================

  lint-js:
    name: Lint (JS/TS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run ESLint
        run: yarn lint

      - name: Check formatting
        run: yarn format

  typecheck-js:
    name: Typecheck (JS/TS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run TypeScript checks
        run: yarn typecheck

  test-js:
    name: Test (JS/TS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run CDK tests
        run: yarn workspace @phspectra/infrastructure test

  # ===========================================================================
  # Build (requires all lint/test jobs to pass)
  # ===========================================================================

  build:
    name: Build
    runs-on: ubuntu-latest
    needs:
      # Python
      - lint-python
      - typecheck-python
      - test-python
      # JS/TS
      - lint-js
      - typecheck-js
      - test-js
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build all workspaces
        run: yarn build

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-build
          path: packages/docs/build/
          retention-days: 7

  # ===========================================================================
  # Deploy Docs to GitHub Pages
  # ===========================================================================

  deploy-docs:
    name: Deploy Docs
    runs-on: ubuntu-latest
    needs: [build]
    # Only deploy on push to main, not on PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-build
          path: ./docs-build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs-build

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ===========================================================================
  # Summary
  # ===========================================================================

  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [build, deploy-docs]
    if: always()
    steps:
      - name: Check results
        run: |
          # Build must succeed
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "Build failed"
            exit 1
          fi

          # Deployment must succeed or be skipped (skipped on PRs)
          if [[ "${{ needs.deploy-docs.result }}" == "failure" ]]; then
            echo "Docs deployment failed"
            exit 1
          fi

          echo "All CI checks passed!"
          if [[ "${{ needs.deploy-docs.result }}" == "success" ]]; then
            echo "  Docs deployed to GitHub Pages"
          fi
